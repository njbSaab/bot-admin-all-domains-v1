<!-- src/app/admin/pages/quiz/components/chain-email-editor/chain-email-editor.component.html -->

<div class="chain-editor" *ngIf="steps$ | async as steps">
  
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-bold text-primary flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
        <polyline points="22,6 12,13 2,6"/>
      </svg>
      –¶–µ–ø–æ—á–∫–∞ –ø–∏—Å–µ–º ({{ steps.length }} {{ steps.length === 1 ? '–ø–∏—Å—å–º–æ' : '–ø–∏—Å–µ–º' }})
    </h3>
    
    <button class="btn btn-sm btn-primary gap-1" (click)="addStep()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"/>
        <line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      –î–æ–±–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ
    </button>
  </div>

  <!-- Timeline –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
  <div class="timeline-wrapper mb-6">
    <div class="flex items-center gap-2 overflow-x-auto pb-2">
      <ng-container *ngFor="let step of steps; let i = index; let last = last">
        <!-- Step indicator -->
        <button 
          class="timeline-step flex flex-col items-center p-3 rounded-lg transition-all min-w-[100px]"
          [class.active]="activeStepIndex === i"
          [class.bg-primary]="activeStepIndex === i"
          [class.text-white]="activeStepIndex === i"
          [class.bg-base-200]="activeStepIndex !== i"
          (click)="selectStep(i)">
          <div class="text-2xl font-bold">{{ step.step }}</div>
          <div class="text-xs opacity-80">{{ step.delayLabel }}</div>
          <div class="text-xs truncate max-w-[80px]" [title]="step.subject">
            {{ step.subject | slice:0:12 }}{{ step.subject.length > 12 ? '...' : '' }}
          </div>
          <span *ngIf="step.isDirty" class="badge badge-warning badge-xs mt-1">–∏–∑–º–µ–Ω–µ–Ω–æ</span>
        </button>
        
        <!-- Arrow between steps -->
        <svg *ngIf="!last" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-base-300 flex-shrink-0">
          <line x1="5" y1="12" x2="19" y2="12"/>
          <polyline points="12 5 19 12 12 19"/>
        </svg>
      </ng-container>
    </div>
  </div>

  <!-- Steps accordion -->
  <div class="steps-list space-y-4">
    <div 
      *ngFor="let step of steps; let i = index; trackBy: trackByStep"
      class="step-card border rounded-xl overflow-hidden transition-all"
      [class.border-primary]="step.isExpanded"
      [class.shadow-lg]="step.isExpanded">
      
      <!-- Step header -->
      <div 
        class="step-header flex items-center justify-between p-4 cursor-pointer"
        [class.bg-primary]="step.isExpanded"
        [class.text-white]="step.isExpanded"
        [class.bg-base-200]="!step.isExpanded"
        (click)="toggleStep(i)">
        
        <div class="flex items-center gap-3">
          <div class="step-number w-8 h-8 rounded-full flex items-center justify-center font-bold"
               [class.bg-white]="step.isExpanded"
               [class.text-primary]="step.isExpanded"
               [class.bg-primary]="!step.isExpanded"
               [class.text-white]="!step.isExpanded">
            {{ step.step }}
          </div>
          <div>
            <div class="font-semibold">{{ step.subject || '–ü–∏—Å—å–º–æ #' + step.step }}</div>
            <div class="text-sm opacity-70">–ß–µ—Ä–µ–∑ {{ step.delayLabel }}</div>
          </div>
        </div>
        
        <div class="flex items-center gap-2">
          <span *ngIf="step.isDirty" class="badge badge-warning">–∏–∑–º–µ–Ω–µ–Ω–æ</span>
          
          <button 
            class="btn btn-ghost btn-sm btn-circle"
            [class.text-white]="step.isExpanded"
            (click)="$event.stopPropagation(); removeStep(i)"
            *ngIf="steps.length > 1">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
          
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               [class.rotate-180]="step.isExpanded"
               class="transition-transform">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </div>
      </div>
      
      <!-- Step content -->
      <div *ngIf="step.isExpanded" class="step-content p-4 bg-base-100 space-y-4">
        
        <!-- Subject & Delay -->
        <div class="grid grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">–¢–µ–º–∞ –ø–∏—Å—å–º–∞</span>
            </label>
            <input 
              type="text" 
              [value]="step.subject"
              (input)="updateStepSubject(i, $any($event.target).value)"
              class="input input-bordered w-full"
              placeholder="–¢–µ–º–∞ –ø–∏—Å—å–º–∞..." />
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑</span>
            </label>
            <select 
              [value]="step.delayMinutes"
              (change)="updateStepDelay(i, +$any($event.target).value)"
              class="select select-bordered w-full">
              <option *ngFor="let preset of delayPresets" [value]="preset.minutes">
                {{ preset.label }}
              </option>
            </select>
          </div>
        </div>

        <!-- Tabs -->
        <div class="tabs tabs-boxed bg-base-200">
          <a class="tab tab-active">üìù –ö–æ–Ω—Ç–µ–Ω—Ç</a>
          <a class="tab">üé® –¶–≤–µ—Ç–∞</a>
        </div>

        <!-- Content fields -->
        <div class="space-y-3">
          <div class="form-control">
            <label class="label"><span class="label-text">–ó–∞–≥–æ–ª–æ–≤–æ–∫</span></label>
            <input 
              type="text" 
              [value]="step.config.titleText"
              (input)="updateStepConfig(i, 'titleText', $any($event.target).value)"
              class="input input-bordered w-full input-sm" />
          </div>
          
          <div class="form-control">
            <label class="label"><span class="label-text">–í—ã–¥–µ–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫</span></label>
            <textarea 
              [value]="step.config.highlightText"
              (input)="updateStepConfig(i, 'highlightText', $any($event.target).value)"
              class="textarea textarea-bordered w-full textarea-sm h-16"></textarea>
          </div>
          
          <div class="form-control">
            <label class="label"><span class="label-text">–û–ø–∏—Å–∞–Ω–∏–µ</span></label>
            <textarea 
              [value]="step.config.descriptionText"
              (input)="updateStepConfig(i, 'descriptionText', $any($event.target).value)"
              class="textarea textarea-bordered w-full textarea-sm h-16"></textarea>
          </div>
          
          <div class="form-control">
            <label class="label"><span class="label-text">–ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é</span></label>
            <input 
              type="text" 
              [value]="step.config.callToAction"
              (input)="updateStepConfig(i, 'callToAction', $any($event.target).value)"
              class="input input-bordered w-full input-sm" />
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div class="form-control">
              <label class="label"><span class="label-text">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏</span></label>
              <input 
                type="text" 
                [value]="step.config.btnText"
                (input)="updateStepConfig(i, 'btnText', $any($event.target).value)"
                class="input input-bordered w-full input-sm" />
            </div>
            <div class="form-control">
              <label class="label"><span class="label-text">–°—Å—ã–ª–∫–∞ –∫–Ω–æ–ø–∫–∏</span></label>
              <input 
                type="url" 
                [value]="step.config.btnLink"
                (input)="updateStepConfig(i, 'btnLink', $any($event.target).value)"
                class="input input-bordered w-full input-sm" />
            </div>
          </div>
        </div>

        <!-- Quick color pickers -->
        <div class="flex flex-wrap gap-4 pt-2 border-t">
          <div class="form-control">
            <label class="label"><span class="label-text text-xs">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç</span></label>
            <input 
              type="color" 
              [value]="step.config.primaryColor"
              (input)="updateStepColor(i, 'primaryColor', $event)"
              class="w-8 h-8 rounded cursor-pointer" />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text text-xs">–®–∞–ø–∫–∞ (–Ω–∞—á–∞–ª–æ)</span></label>
            <input 
              type="color" 
              [value]="step.config.headerBgStart"
              (input)="updateStepColor(i, 'headerBgStart', $event)"
              class="w-8 h-8 rounded cursor-pointer" />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text text-xs">–®–∞–ø–∫–∞ (–∫–æ–Ω–µ—Ü)</span></label>
            <input 
              type="color" 
              [value]="step.config.headerBgEnd"
              (input)="updateStepColor(i, 'headerBgEnd', $event)"
              class="w-8 h-8 rounded cursor-pointer" />
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text text-xs">–ö–Ω–æ–ø–∫–∞</span></label>
            <input 
              type="color" 
              [value]="step.config.btnBgStart"
              (input)="updateStepColor(i, 'btnBgStart', $event)"
              class="w-8 h-8 rounded cursor-pointer" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="steps.length === 0" class="text-center py-12 bg-base-200 rounded-xl">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="mx-auto text-base-content/30 mb-4">
      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
      <polyline points="22,6 12,13 2,6"/>
    </svg>
    <p class="text-base-content/50 mb-4">–ù–µ—Ç –ø–∏—Å–µ–º –≤ —Ü–µ–ø–æ—á–∫–µ</p>
    <button class="btn btn-primary" (click)="addStep()">
      –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ
    </button>
  </div>
</div>