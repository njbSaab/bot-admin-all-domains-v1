<app-sidebar></app-sidebar>

<section class="admin-page ml-side section">
  <div class="container mx-auto pt-[10px]">
    <div
      class="bg-main-trans2-gradient-90 header-tab flex items-center justify-between py-[10px] mb-0 rounded-[20px] w-full pr-4"
    >
      <h2 class="title-tab text-2xl font-bold text-indigo-600">Пользователи</h2>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="40"
        height="40"
        viewBox="0 0 24 24"
      >
        <g
          fill="#4f45e5"
          fill-opacity="0"
          stroke="#4f45e5"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
        >
          <path
            stroke-dasharray="20"
            stroke-dashoffset="20"
            d="M12 5c1.66 0 3 1.34 3 3c0 1.66 -1.34 3 -3 3c-1.66 0 -3 -1.34 -3 -3c0 -1.66 1.34 -3 3 -3Z"
          >
            <animate
              fill="freeze"
              attributeName="stroke-dashoffset"
              dur="0.4s"
              values="20;0"
            />
          </path>
          <path
            stroke-dasharray="36"
            stroke-dashoffset="36"
            d="M12 14c4 0 7 2 7 3v2h-14v-2c0 -1 3 -3 7 -3Z"
          >
            <animate
              fill="freeze"
              attributeName="stroke-dashoffset"
              begin="0.5s"
              dur="0.5s"
              values="36;0"
            />
          </path>
          <animate
            fill="freeze"
            attributeName="fill-opacity"
            begin="1.1s"
            dur="0.5s"
            values="0;1"
          />
        </g>
      </svg>
    </div>

    <!-- Индикатор загрузки -->
    <div *ngIf="isLoading" class="text-center py-4">
      <app-loading></app-loading>
    </div>

    <!-- Отображение ошибки -->
    <div *ngIf="error" class="text-red-500 text-center">
      {{ error }}
    </div>

    <!-- Таблица пользователей -->
    <div *ngIf="!isLoading && users.length" class="overflow-x-auto mt-4">
      <div class="overflow-x-auto">
        <table class="table">
          <!-- head -->
          <thead>
            <tr>
              <th>$</th>
              <th (click)="toggleSort('id')" class="cursor-pointer">
                Telegram ID
                <span *ngIf="sortBy === 'id'">
                  {{ ascending ? "↑" : "↓" }}
                </span>
              </th>
              <th (click)="toggleSort('first_name')" class="cursor-pointer">
                First Name
                <span *ngIf="sortBy === 'first_name'">
                  {{ ascending ? "↑" : "↓" }}
                </span>
              </th>
              <th>Last Name</th>
              <th>Username</th>
              <th (click)="toggleSort('email')" class="cursor-pointer">
                Email
                <span *ngIf="sortBy === 'email'">
                  {{ ascending ? "↑" : "↓" }}
                </span>
              </th>
              <th (click)="toggleSort('state')" class="cursor-pointer">
                State
                <span *ngIf="sortBy === 'state'">
                  {{ ascending ? "↑" : "↓" }}
                </span>
              </th>
              <th>isBot</th>
              <th (click)="toggleSort('language_code')" class="cursor-pointer">
                Lang
                <span *ngIf="sortBy === 'language_code'">
                  {{ ascending ? "↑" : "↓" }}
                </span>
              </th>
              <th (click)="toggleSort('updated_at')" class="cursor-pointer">
                Update
                <span *ngIf="sortBy === 'updated_at'">
                  {{ ascending ? "↑" : "↓" }}
                </span>
              </th>
              <th>Categories</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let user of sortedUsers; let i = index"
              [ngClass]="{ hover: i % 2 === 1 }"
            >
              <th>{{ i + 1 }}</th>
              <th>{{ user.id }}</th>
              <td>{{ user.first_name }}</td>
              <td>{{ user.last_name || "-" }}</td>
              <td>{{ user.username || "-" }}</td>
              <td>{{ user.email || "-" }}</td>
              <td>{{ user.state }}</td>
              <td>{{ user.is_bot }}</td>
              <td>{{ user.language_code }}</td>
              <td>{{ user.updated_at.slice(0, 16) }}</td>
              <td>
                <ng-container
                  *ngIf="
                    user.newsCategories && user.newsCategories.length;
                    else noSubs
                  "
                >
                  <span
                    *ngFor="let cat of user.newsCategories"
                    class="badge badge-info mr-1"
                  >
                    {{ cat.name }}
                  </span>
                </ng-container>
                <ng-template #noSubs>-</ng-template>
              </td>
              <td>
                <button
                  class="btn hover:btn-error btn-circle hover:text-white"
                  title="Delete User"
                  (click)="
                    deleteUser(
                      user.id,
                      user.first_name || user.username || user.id.toString()
                    )
                  "
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                  >
                    <path
                      fill="currentColor"
                      d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12l1.41 1.41L13.41 14l2.12 2.12l-1.41 1.41L12 15.41l-2.12 2.12l-1.41-1.41L10.59 14zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"
                    />
                  </svg>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Сообщение, если пользователей нет -->
    <div *ngIf="!isLoading && users.length === 0" class="text-center">
      Пользователи не найдены.
    </div>
  </div>
</section>
